import{r as a,j as e,m as te,u as se,k as ae,b as ie,e as p,i as re,R as k,C as R,F as ne,N as u}from"./index-9684c524.js";import{V as E}from"./VideoJs-802bbce1.js";import{S as $}from"./sweetalert2.all-156df1c2.js";import{T as v}from"./Tab-f156d73c.js";import"./video.es-485ceb6b.js";a.forwardRef(({options:n,onReady:r,isOpen:s,onClose:d},o)=>{const i=a.useRef(null);return a.useEffect(()=>{s&&i.current&&i.current.player.play()},[s]),e.jsx("div",{className:`pop-out-player ${s?"open":"closed"}`,onClick:d,children:e.jsx("div",{className:"player-container",onClick:c=>c.stopPropagation(),children:e.jsx(E,{options:n,onReady:r,ref:o,style:{width:"100%",height:"100%"}})})})});class f extends Error{}f.prototype.name="InvalidTokenError";function oe(n){return decodeURIComponent(atob(n).replace(/(.)/g,(r,s)=>{let d=s.charCodeAt(0).toString(16).toUpperCase();return d.length<2&&(d="0"+d),"%"+d}))}function le(n){let r=n.replace(/-/g,"+").replace(/_/g,"/");switch(r.length%4){case 0:break;case 2:r+="==";break;case 3:r+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return oe(r)}catch{return atob(r)}}function ce(n,r){if(typeof n!="string")throw new f("Invalid token specified: must be a string");r||(r={});const s=r.header===!0?0:1,d=n.split(".")[s];if(typeof d!="string")throw new f(`Invalid token specified: missing part #${s+1}`);let o;try{o=le(d)}catch(i){throw new f(`Invalid token specified: invalid base64 for part #${s+1} (${i.message})`)}try{return JSON.parse(o)}catch(i){throw new f(`Invalid token specified: invalid json for part #${s+1} (${i.message})`)}}const T=()=>{const n=localStorage.getItem("jwtToken");if(!n)return!1;try{return ce(n).exp>Date.now()/1e3}catch{return!1}},de=()=>{const[n,r]=a.useState(T());return a.useEffect(()=>{const s=()=>{r(T())};return window.addEventListener("storage",s),()=>window.removeEventListener("storage",s)},[]),n},me=a.memo(()=>{a.useState(!1);const n=te.useRef(null),{t:r}=se(),[s,d]=a.useState(null),{id:o}=ae(),i=ie(t=>{var l;return(l=t.user)==null?void 0:l.user}),c="http://localhost:4000",[y,N]=a.useState(!1),[I,P]=a.useState(!0),[D,J]=a.useState(!1),[M,x]=a.useState(!1),[A,b]=a.useState(0),[K,U]=a.useState(0),[C,O]=a.useState([]),[z,F]=a.useState([]),[V,W]=a.useState([]),[S,Y]=a.useState(null),q=de(),g=a.useCallback(async()=>{try{P(!0);const[t,l,j,w]=await Promise.all([p.get(`${c}/api/movies/${o}`),i?p.get(`${c}/api/movies/${o}/like`,{params:{userId:i._id}}):Promise.resolve(null),p.get(`${c}/api/movies/${o}/like-count`),i?p.post(`${c}/api/payments/status`,{userId:i._id,movieId:o}):Promise.resolve(null)]),m=t.data.data;if(m.release_year=new Date(m.release_date).getFullYear(),d(m),m.trailer_url&&Y(m.trailer_url),l&&x(l.data.isLiked),b(j.data.likeCount),w){const{hasPaid:h,remainingTime:L}=w.data;N(h),U(L)}const Z=m.castAndCrews.map(async h=>({...(await p.get(`${c}/api/persons/${h.person}`)).data,role:h.role,type:h.type})),ee=await Promise.all(Z);O(ee)}catch(t){console.error("Error fetching data:",t)}finally{P(!1),J(!0)}},[c,o,i]);a.useEffect(()=>{g()},[g]),a.useEffect(()=>{F({autoplay:!1,controls:!0,responsive:!0,techOrder:["youtube"],sources:[{src:"https://www.youtube.com/watch?v=Q1GlkwGSkO0",type:"video/youtube"}],youtube:{iv_load_policy:1}}),W({autoplay:!1,controls:!0,responsive:!0,techOrder:["youtube"],sources:[{src:S||"",type:"video/youtube"}],youtube:{iv_load_policy:1}})},[S]);const G=C.filter(t=>t.type==="cast"),H=C.filter(t=>t.type==="crew"),_=()=>setShowModal(!0),Q=a.useCallback(t=>{n.current=t,t.on("play",_),t.on("waiting",()=>{videojs.log("player is waiting")}),t.on("dispose",()=>{videojs.log("player will dispose")})},[_]),B=a.useCallback(async()=>{if(!q){$.fire({icon:"error",title:"Please login first"});return}try{const t=await p.post(`${c}/api/payments/initiate`,{userId:i._id,contentId:o,contentType:"Movie"}),{orderId:l}=t.data,j={key:"rzp_test_jJ41CHspPJeQFW",amount:s.ppv_cost*100,currency:"INR",name:"Movie Payment",description:`Payment for movie: ${s.title}`,order_id:l,handler:async function(m){console.log("Payment successful:",m),N(!0),await g()},prefill:{name:i.full_name,email:i.email,contact:i.phone},notes:{userId:i._id,contentId:o,contentType:"Movie"},theme:{color:"#F37254"}};new window.Razorpay(j).open()}catch(t){console.error("Error initiating payment:",t)}},[c,g,o,s,i]),X=a.useCallback(async()=>{if(!i){$.fire({icon:"error",title:"Please login first"});return}try{(await p.post(`${c}/api/movies/${o}/like`,{userId:i._id})).data.message==="Like removed successfully"?(x(!1),b(l=>l-1)):(x(!0),b(l=>l+1))}catch(t){console.error("Error liking the movie:",t)}},[c,o,i]);return I||!s||!D?e.jsx("div",{children:"Loading..."}):e.jsx("div",{className:`detail-page ${I?"loading":"loaded"}`,children:e.jsx("div",{className:"iq-main-slider site-video",children:e.jsx(re,{fluid:!0,children:e.jsx(k,{children:e.jsx(R,{lg:"12",children:e.jsxs("div",{className:"movie-details-container",children:[e.jsx("div",{className:"movie-details-content",children:e.jsxs("div",{className:"video-container",children:[e.jsx(E,{options:y?z:V,onReady:Q}),!y&&e.jsx("div",{className:"trailer-tag",children:"Trailer"})]})}),e.jsxs("div",{className:"movie-details-description ml-3",children:[e.jsx(k,{children:e.jsxs(R,{md:"12",className:"mb-auto",children:[e.jsx("div",{className:"d-block d-lg-flex align-items-center",children:e.jsx("h2",{className:"trending-text fw-bold text-uppercase my-0 fadeInLeft animated d-inline-block",children:s.title})}),e.jsxs("div",{className:"d-block d-lg-flex align-items-center mb-2",children:[e.jsxs("span",{className:"border border-white p-1",children:["Release Year: ",s.release_year]}),e.jsx("span",{className:"ms-3 font-Weight-500 genres-info me-2 border border-white p-1",children:"1hr : 48mins"})]}),e.jsxs("div",{className:"d-flex flex-wrap align-items-center text-white text-detail flex-wrap mb-4",children:[e.jsx("span",{className:"badge bg-primary",children:s.genres}),e.jsx("span",{className:"trending-year trending-year-list font-Weight-500 genres-info",children:s.created_at})]}),e.jsxs("div",{className:"d-flex align-items-center gap-4 flex-wrap mb-4",children:[e.jsx("ul",{className:"list-inline p-0 share-icons music-play-lists mb-n2 mx-n2",children:e.jsx("li",{children:e.jsx("span",{onClick:X,children:e.jsx("i",{className:`fa-heart ${M?"fa-solid":"far"}`})})})}),e.jsxs("span",{className:"text-white",children:[A," likes"]})]})]})}),y?e.jsxs("span",{children:["You have"," ",e.jsx("span",{className:"text-primary text-strong",children:K})," ","to watch this movie"]}):e.jsxs("button",{className:"pay-button",onClick:B,children:[e.jsx(ne,{size:"1.5em"})," Rent for Rs."," ",s.ppv_cost," (3 days)"]}),e.jsx(k,{children:e.jsx("div",{className:"details-part content-details trending-info",children:e.jsxs(v.Container,{defaultActiveKey:"first",children:[e.jsxs(u,{className:"iq-custom-tab tab-bg-gredient-center d-flex nav nav-pills align-items-center text-center mb-5 justify-content-left list-inline",children:[e.jsx(u.Item,{children:e.jsx(u.Link,{eventKey:"first",variant:" d-flex align-items-center",id:"nav-description-tab","data-bs-toggle":"tab","data-bs-target":"#nav-description",type:"button",role:"tab","aria-controls":"nav-description","aria-selected":"true",children:r("detail_page.description")})}),e.jsx(u.Item,{children:e.jsx(u.Link,{eventKey:"second",variant:"",id:"nav-review-tab","data-bs-toggle":"tab","data-bs-target":"#nav-review",type:"button",role:"tab","aria-controls":"nav-review","aria-selected":"false",children:"Casts"})}),e.jsx(u.Item,{children:e.jsx(u.Link,{eventKey:"third",variant:"",id:"nav-review-tab","data-bs-toggle":"tab","data-bs-target":"#nav-review",type:"button",role:"tab","aria-controls":"nav-review","aria-selected":"false",children:"Crews"})})]}),e.jsxs(v.Content,{children:[e.jsx(v.Pane,{className:"fade show",eventKey:"first",id:"nav-description",role:"tabpanel","aria-labelledby":"nav-description-tab",children:e.jsx("p",{children:r(s.description)})}),e.jsx(v.Pane,{className:"fade",id:"nav-review",eventKey:"second",role:"tabpanel","aria-labelledby":"nav-review-tab",children:e.jsx("div",{className:"cast-list",children:G.map((t,l)=>e.jsxs("div",{className:"cast-item",children:[e.jsx("img",{src:t.image_url,alt:t.name,className:"cast-image"}),e.jsx("p",{children:t.name||"Loading..."})]},l))})}),e.jsx(v.Pane,{className:"fade",id:"nav-review",eventKey:"third",role:"tabpanel","aria-labelledby":"nav-review-tab",children:e.jsx("div",{className:"cast-list",children:H.map((t,l)=>e.jsxs("div",{className:"cast-item",children:[e.jsx("h5",{children:t.role}),e.jsx("img",{src:t.image_url,alt:t.name,className:"cast-image"}),e.jsx("p",{children:t.name||"Loading..."})]},l))})})]})]})})})]})]})})})})})})});me.displayName="DetailPage";export{me as default};
